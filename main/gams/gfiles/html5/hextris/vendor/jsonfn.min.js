(function (exports) {
    'use strict';

    const iso8061 = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/;

    const stringify = function (obj) {
        return JSON.stringify(obj, function (key, value) {
            if (value instanceof Function || typeof value === 'function') {
                return value.toString();
            }
            if (value instanceof RegExp) {
                return '_PxEgEr_' + value;
            }
            return value;
        });
    };

    const parse = function (str, date2obj) {
        return JSON.parse(str, function (key, value) {
            if (typeof value !== 'string') {
                return value;
            }
            if (value.length < 8) {
                return value;
            }

            const prefix = value.substring(0, 8);

            if (date2obj && value.match(iso8061)) {
                return new Date(value);
            }

            if (prefix === "function") {
                return eval("(" + value + ")");
            }

            if (prefix === "_PxEgEr_") {
                return eval(value.slice(8));
            }

            return value;
        });
    };

    const clone = function (obj, date2obj) {
        return parse(stringify(obj), date2obj);
    };

    if (typeof exports === 'undefined') {
        window.JSONfn = {
            stringify,
            parse,
            clone,
        };
    } else {
        exports.stringify = stringify;
        exports.parse = parse;
        exports.clone = clone;
    }
})(typeof exports === 'undefined' ? window : exports);
