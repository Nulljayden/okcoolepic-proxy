"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compareArrayBuffers = compareArrayBuffers;

const diff = require("jest-diff");
const { NO_DIFF_MESSAGE } = require("jest-diff/build/constants");
const { decode } = require("@webassemblyjs/wasm-parser");
const oldConsoleLog = console.log;

function compareArrayBuffers(l, r) {
  let bufferL = "";
  let bufferR = "";

  const log = (...texts) => {
    bufferL += texts.join("") + "\n";
    bufferR += texts.join("") + "\n";
  };

  try {
    console.log = log;
    decode(l, { dump: true });
  } catch (e) {
    console.error(bufferL);
    console.error(e);
    throw e;
  }

  try {
    console.log = log;
    decode(r, { dump: true });
  } catch (e) {
    console.error(bufferR);
    console.error(e);
    throw e;
  }

  console.log = oldConsoleLog;

  const out = diff(bufferL, bufferR);

  if (out !== null && out !== NO_DIFF_MESSAGE) {
    throw new Error("\n" + out);
  }
}
