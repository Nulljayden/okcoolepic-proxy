const diff = require("jest-diff");
const decode = require("@webassemblyjs/wasm-parser").decode;
const { NO_DIFF_MESSAGE } = require("jest-diff/build/constants");

const oldConsoleLog = console.log;

/**
 * Compares two ArrayBuffers by decoding them to text and then comparing the text using jest-diff.
 * @param {ArrayBuffer} l - The left ArrayBuffer to compare.
 * @param {ArrayBuffer} r - The right ArrayBuffer to compare.
 * @throws {Error} If the decoded text of the two ArrayBuffers is different.
 */
function compareArrayBuffers(l, r) {
  const decodeAndLog = (buffer, label) => {
    let bufferString = "";
    console.log = (...texts) => {
      bufferString += texts.join("") + "\n";
    };

    try {
      decode(buffer, { dump: true });
    } catch (e) {
      console.error(bufferString);
      console.error(e);
      throw e;
    }

    console.log = oldConsoleLog;
    return bufferString;
  };

  const leftBufferString = decodeAndLog(l, "left");
  const rightBufferString = decodeAndLog(r, "right");

  const diffResult = diff(leftBufferString, rightBufferString);

  if (diffResult !== null && diffResult !== NO_DIFF_MESSAGE) {
    throw new Error("\n" + diffResult);
  }
}

module.exports = compareArrayBuffers;
